<style>
    .table .imageContainer {
        display: inline-block;
        border: 1px dashed #aaa;
        padding: 2px;
        width: 100px;
    }
    .v-table .tableForm {
        margin: 0;
        padding: 0;
    }

    .v-table .not-persisted {
        background: #fff8e5 !important;
    }

    .v-table .persisted {
        background: #e5ffec !important;
    }

    .v-table .selected {
        background: #aad5ff !important;
    }

    .v-table .deleted {
        background: #db4747 !important;
    }
</style>
<script id="TableComponentTemplate" type="text/template">
    <div :id="elementId">
        <div class="alert alert-with-icon" data-notify="container" v-show="list.length <= 0">
            <i class="material-icons" data-notify="icon">border_clear</i>
            <span data-notify="message">Aucune donnée à afficher !</span>
        </div>

        <div class="row">
            <div class="col-sm-6">
                <div class="dataTables_length">
                    Affiche 
                    <select name="datatables_length" v-model="pager.size">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                    </select> entrées
                </div>
            </div>
            <div class="col-sm-6">
            </div>
        </div>

        <div class="row">
            <div class="col-sm-12">
                <table class="table table-striped table-no-bordered table-hover" cellspacing="0" width="100%" style="width:100%">
                    <thead>
                        <tr>
                            <th v-if="detailRowDefined"></th>
                            <template v-for="h in getHeaders">
                                <th v-if="show(h)">
                                    {{ getLabel(h) }}
                                </th>
                            </template>
                            <th v-if="actionComponentDefined"></th>
                            <th v-for="addColumn in additionalColumns">
                                {{ addColumn.GRID_NAME }}
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <template v-for="(item, index) in list.slice(pager.sliceFrom, pager.sliceTo)">
                            <tr :class="listConfig[index].rowClass" v-show="!editable || (editable && listConfig[index].state !== 'deleted')">
                                @*DETAIL ROW BTN*@
                                <td v-if="detailRowDefined"
                                    v-on:click="toggleDetailRow(getLineIndex(index))">
                                    <i class="material-icons i-btn-round" v-show="showDetailRow[getLineIndex(index)] != null && showDetailRow[getLineIndex(index)]">expand_less</i>
                                    <i class="material-icons i-btn-round" v-show="showDetailRow[getLineIndex(index)] == null || !showDetailRow[getLineIndex(index)]">expand_more</i>
                                </td>

                                @*TABLE COLUMNS*@
                                <template v-for="(h,colIndex) in getHeaders">
                                    <template v-if="show(h)">
                                        <template v-if="isForm(h)">
                                            <td>
                                                <component :name="columns[h].form.type + '-' + index + '-' + colIndex"
                                                           :id="elementId + '¤' + h + '_' + index"
                                                           :is="columns[h].form.type"
                                                           v-model="item[h]"
                                                           v-bind='{cssClass:"tableForm",line:index, column: colIndex, datasource:columns[h].form.datasource, disabled:columns[h].form.disabled}'
                                                           v-on:input="lineChanged"
                                                           @*v-bind="{id:field.DB_NAME,label:field.FORM_NAME,optional:field.FORM_OPTIONAL,datasource:field.FORM_SOURCE,fieldName:field.DB_NAME}"*@></component>
                                            </td>
                                        </template>
                                        <template v-else>
                                            <template v-if="typeof listConfig[getLineIndex(index)].columns != 'undefined' && listConfig[getLineIndex(index)].columns[h].isFile">
                                                <td>
                                                    <a href="javascript:;" v-on:click="downloadFile(item[h].base64, item[h].type, item[h].name)">
                                                        <template v-if="item[h].type.match('image') !== null">
                                                            <div class="imageContainer">
                                                                <img :src="item[h].base64" />
                                                            </div>
                                                        </template>
                                                        <template v-else>
                                                            <div class="fileContainer">
                                                                <i class="material-icons">attachment</i> : {{ item[h].name }}
                                                            </div>
                                                        </template>
                                                    </a>
                                                </td>
                                            </template>
                                            <template v-else>
                                                <td v-format="{value:item[h], format:getFormat(h)}">
                                                    {{ item[h] }}
                                                </td>
                                            </template>
                                        </template>
                                    </template>
                                </template>

                                @*ACTION COMPONENET*@
                                <td v-if="actionComponentDefined">
                                    <component v-bind:is="actionComponent" v-bind="{row:item, index: getLineIndex(index)}"></component>
                                </td>

                                @*ADDITIONA COLUMN*@
                                <td v-for="addColumn in additionalColumns">
                                    <template v-if="addColumn.GRID_FORMAT.type == 'button'">
                                        <div class="pull-right">
                                            <button :class="addColumn.GRID_FORMAT.color + ' btn btn-round btn-fab btn-fab-mini btn-fab-x-mini'"
                                                    v-on:click="additionalColumnAction(addColumn.GRID_FORMAT.action, addColumn.GRID_FORMAT.data, item.BO_ID)">
                                                <i class="material-icons">{{ addColumn.GRID_FORMAT.icon }}</i>
                                            </button>
                                        </div>
                                    </template>
                                    <template v-else>
                                        {{ addColumn.GRID_FORMAT }}
                                    </template>
                                </td>

                                @*EDITABLE ACTIONS*@
                                <td v-if="editable" style="white-space: nowrap;">
                                    <button class="btn btn-success btn-round btn-fab btn-fab-mini btn-fab-x-mini"
                                            v-show="listConfig[index].changed"
                                            v-on:click="submitLine(index)">
                                        <i class="material-icons">save</i>
                                    </button>
                                    <button class="btn btn-danger btn-round btn-fab btn-fab-mini btn-fab-x-mini"
                                            v-show="index < list.length-1"
                                            v-on:click="deleteLine(index)">
                                        <i class="material-icons">delete</i>
                                    </button>
                                </td>
                            </tr>

                            @*DETAIL ROW*@
                            <tr class="detailRow" v-if="detailRowDefined" v-show="showDetailRow[getLineIndex(index)] != null && showDetailRow[getLineIndex(index)]">
                                <td v-bind:colspan="columnCount">
                                    <template v-if="isDefaultDetailRow">
                                        @*DRAW DEFAULT DETAIL ROW*@
                                        <div v-for="h in getHeaders" class="col-md-3">
                                            <b>{{ getLabel(h) }} : </b>
                                            <template v-if="listConfig[getLineIndex(index)].columns[h].isFile">
                                                <span>
                                                    <a href="javascript:;" v-on:click="downloadFile(item[h].base64, item[h].type, item[h].name)">
                                                        <template v-if="item[h].type.match('image') !== null">
                                                            <div class="imageContainer" style="vertical-align: top;">
                                                                <img :src="item[h].base64" />
                                                            </div>
                                                        </template>
                                                        <template v-else>
                                                            <div class="fileContainer">
                                                                <i class="material-icons">attachment</i> : {{ item[h].name }}
                                                            </div>
                                                        </template>
                                                    </a>
                                                </span>
                                            </template>
                                            <template v-else>
                                                <span v-format="{value:item[h], format:getFormat(h)}">
                                                    {{ item[h] }}
                                                </span>
                                            </template>
                                        </div>
                                    </template>
                                    <template v-else>
                                        @*DRAW CUSTOM ONE*@
                                        <component v-bind:is="detailRow" v-bind="{row:item,metafield:meta_field}"></component>
                                    </template>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="row">
            <div class="col-md-4" style="padding-top: 25px;">
                <div class="dataTables_info">
                    Affiche {{ (pager.current*pager.size)+1 }}
                    à
                    <template v-if="pager.current+1 == pager.count">
                        {{ pager.countEntries }}
                    </template>
                    <template v-else>
                        {{ ((pager.current+1)*pager.size) }}
                    </template>
                    de {{ pager.countEntries }} entrées
                </div>
            </div>
            <div class="col-md-8">
                <div class="paging_full_numbers pull-right">
                    <ul class="pagination">
                        <li v-on:click="pager.current = 0"
                            :class="'paginate_button ' + (pager.current==0 ?  'disabled':'')">
                            <a href="javascript:;" tabindex="0">Début</a>
                        </li>
                        <li v-on:click="pager.current += pager.current>0 ? -1 : 0"
                            :class="'paginate_button ' + (pager.current==0 ?  'disabled':'')">
                            <a href="javascript:;" tabindex="0">Précédent</a>
                        </li>
                        <template>
                            <li v-for="index in pager.pages"
                                v-on:click="pager.current=index"
                                :class="'paginate_button ' + (pager.current==index ? 'active' : '')">
                                <a href="javascript:;" :tabindex="index">{{ index+1 }}</a>
                            </li>
                        </template>
                        <li v-on:click="pager.current += pager.current<(pager.count-1) ? 1 : 0"
                            :class="'paginate_button ' + (pager.current+1 == pager.count ?  'disabled':'')">
                            <a href="javascript:;" tabindex="0">Suivant</a>
                        </li>
                        <li v-on:click="pager.current = pager.count-1"
                            :class="'paginate_button ' + (pager.current+1 == pager.count ?  'disabled':'')">
                            <a href="javascript:;" tabindex="0">Dernier</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</script>
<script type="text/javascript">
    Vue.component('v-table', {
        template: $("#TableComponentTemplate").html(),
        mixins: [MixinBase, PagerMixin],
        props: {
            datasource: String,
            columnIgnore: Array,
            columnShow: Array,
            columnLabels: Object,
            columns: Object,
            detailRow: String,
            actionComponent: String,
            metaName: String,
            editable: {
                type: Boolean,
                default: false
            },
            pk: String,
            preventFirstLoad: {
                type: Boolean,
                default: false
            },
            showDeleted: {
                type: Boolean,
                default: false
            },
        },
        data: function () {
            return {
                list: [],
                listConfig: [],
                showDetailRow: [],
                dataSourceUrl: "",
                meta: null,
                meta_field: {},
                additionalColumns: [],
                api: EV.getComponent("data"),
                defaultValues: null
            }
        },
        computed: {
            getHeaders: function () {
                if (this.list.length > 0) {
                    var headers = [];
                    for (var h in this.list[0]) {
                        headers.push(h);
                    }
                    return headers;
                }
                else
                    return [];
            },
            columnCount: function () {
                return this.getHeaders.length + this.additionalColumns.length + (this.actionComponentDefined ? 1 : 0);
            },
            detailRowDefined: function () {
                return this.detailRow != null;
            },
            isDefaultDetailRow: function () {
                return this.detailRow.toLowerCase().trim() === "default";
            },
            actionComponentDefined: function () {
                return this.actionComponent != null;
            },
            fields: function () {
                if (this.meta === null) return null;
                var a = {};
                this.meta.META_FIELD.forEach((e) => {
                    a[e.DB_NAME] = e;

                    if (e.FORM_SOURCE !== null)
                        try { a[e.DB_NAME].FORM_SOURCE = JSON.parse(e.FORM_SOURCE) } catch{ }

                    if (e.GRID_FORMAT !== null) {
                        try {
                            a[e.DB_NAME].GRID_FORMAT = JSON.parse(e.GRID_FORMAT);
                            if (e.DB_NAME === "additional.column")
                                this.additionalColumns.push(e);
                        } catch{ }
                    }
                    if (e.FORM_FORMAT !== null)
                        try { a[e.DB_NAME].FORM_FORMAT = JSON.parse(e.FORM_FORMAT) } catch{ }
                });
                return a;
            }
        },
        methods: {
            setList: function (data) {
                var me = this;
                setTimeout(() => {
                    me.list = data;
                    if (me.paging) me.initPager(me.list);

                    me.listConfig = [];
                    for (var i in me.list) {
                        var config = { rowClass: "", state: "old", changed: false, columns: {} };

                        for (var colIdx in me.list[i]) {
                            config.columns[colIdx] = { isFile: false };
                            try {
                                var json = JSON.parse(me.list[i][colIdx]);
                                config.columns[colIdx].isFile = typeof json.base64 !== "undefined";
                                me.list[i][colIdx] = json;
                            } catch (e) {

                            }
                        }

                        me.listConfig.push(config);
                    }
                    if (me.editable) me.newLine();
                }, 100);
            },
            load: function (url, done) {
                var me = this;
                if (typeof me.dataSourceUrl === "undefined" && typeof url === "undefined") return;
                if (typeof url !== "undefined") me.dataSourceUrl = url;
                else url = me.dataSourceUrl;

                if (this.preventFirstLoad) return;
                var data = EV.getComponent("data");
                data.ExecuteSource({
                    url: url,
                    loadComplete: function (obj, response) {
                        // console.log("loadComplete", response);
                        me.setList(response);

                        if (typeof done === "function") done(response);
                    }
                });
            },
            clear: function () {
                this.list = [];
            },
            loadObject: function (obj) {
                this.setList(obj);
            },
            show: function (colName) {
                if (typeof this.columnShow !== "undefined") {
                    return this.columnShow.includes(colName);
                } else {
                    if (typeof this.columnIgnore === "undefined")
                        return true;
                    else
                        return !this.columnIgnore.includes(colName);
                }
            },
            getLabel: function (colName) {
                if (typeof this.columns === "undefined" || typeof this.columns[colName] === "undefined") {
                    if (typeof this.columnLabels === "undefined" || typeof this.columnLabels[colName] === "undefined")
                        return colName;
                    else
                        return this.columnLabels[colName];
                } else
                    return this.columns[colName].header;                
            },
            toggleDetailRow: function (index) {
                this.$set(this.showDetailRow, index, this.showDetailRow[index] == null ? true : !this.showDetailRow[index]);
            },
            getFormat: function (column) {
                if (this.meta === null) {
                    if (typeof this.columns === "undefined") return null;
                    if (typeof this.columns[column] === "undefined") return null;
                    if (typeof this.columns[column].format === "undefined") return null;

                    return this.columns[column].format;
                } else {
                    if (typeof this.fields[column] === "undefined") return null;
                    if (typeof this.fields[column].GRID_FORMAT === "undefined") return null;
                    return this.fields[column].GRID_FORMAT;
                }
            },
            additionalColumnAction: function (action, data, id) {
                switch (action) {
                    case "redirect":
                        window.location = URL.addPart(data, id);
                        break;
                    default:
                }
            },
            getLineIndex: function (index) {
                return (this.pager.current * this.pager.size) + index;
            },
            isForm: function (colName) {
                if (typeof this.columns === "undefined") return false;
                if (typeof this.columns[colName] === "undefined") return false;
                if(typeof this.columns[colName].form === "undefined") return false;
                return true;
            },
            lineChanged: function (value, payload) {
                // console.log(payload);
                //if (payload.firstLoad) return;
                this.listConfig[payload.line].rowClass = "not-persisted";
                this.listConfig[payload.line].changed = true;
            },
            submitLine: function (lineIndex) {
                this.$emit('before-submit', this.list[lineIndex]);

                var me = this;
                if (this.listConfig[lineIndex].state == "new") {
                    me.list[lineIndex][me.pk] = 0;
                    me.api.Post({
                        url: me.datasource,
                        data: JSON.stringify(me.list[lineIndex]),
                        done: function (response) {
                            me.newLine();
                            me.submited(response, lineIndex);
                        }
                    });
                } else {
                    me.api.Put({
                        url: URL.addPart(me.datasource, me.list[lineIndex][me.pk]),
                        data: JSON.stringify(me.list[lineIndex]),
                        done: function (response) {
                            me.submited(response, lineIndex);
                        }
                    });
                }
            },
            deleteLine: function (lineIndex) {
                var me = this;

                if (this.listConfig[lineIndex].state == "new") {
                    me.listConfig[lineIndex].state = "deleted";
                } else {
                    NOTIF.confirm({
                        title: "Supprimer",
                        text: "Etes-vous sûr ?",
                        valider: function () {
                            me.api.Delete({
                                url: URL.addPart(me.datasource, me.list[lineIndex][me.pk]),
                                done: function (response) {
                                    if (!me.showDeleted) me.listConfig[lineIndex].state = "deleted";

                                    me.listConfig[lineIndex].rowClass = "deleted";

                                    if (typeof response !== "undefined") me.list[lineIndex] = response;
                                }
                            });
                        }
                    });
                }
            },
            submited: function (response, lineIndex) {
                if (typeof response !== "undefined") this.list[lineIndex] = response;
                this.listConfig[lineIndex].rowClass = "persisted";
                this.listConfig[lineIndex].changed = false;
                this.listConfig[lineIndex].state = "old";
                this.$emit("submited", this.list[lineIndex]);
            },
            newLine: function () {
                // console.log("newLine");
                var line = {};
                if (this.getHeaders.length > 0) { // TABLE IS NOT EMPTY
                    for (var i in this.getHeaders) {
                        if (this.defaultValues != null && typeof this.defaultValues !== "undefined" && typeof this.defaultValues[this.getHeaders[i]] !== "undefined")
                            line[this.getHeaders[i]] = this.defaultValues[this.getHeaders[i]];
                        else
                            line[this.getHeaders[i]] = "";
                    }
                } else { // TABLE IS EMPTY
                    for (var i in this.columns) {
                        if (this.defaultValues != null && typeof this.defaultValues !== "undefined" && typeof this.defaultValues[i] !== "undefined")
                            line[i] = this.defaultValues[i];
                        else
                            line[i] = "";
                    }
                }

                this.list.push(line);
                this.listConfig.push({ rowClass: "not-persisted", state: "new", changed: false });
            },
            selectLine: function (index) {
                for (var i in this.listConfig) {
                    if (this.listConfig[i].rowClass.match("selected") !== null) this.listConfig[i].rowClass = "";
                }
                this.listConfig[index].rowClass = "selected";
            }
        },
        mounted: function () {
            this.dataSourceUrl = this.datasource;
            this.load();
            me = this;
            // BIND TO BUS META
            if (typeof this.metaName === "undefined") return "";
            if (typeof bus.$data[this.metaName] === "undefined") return "";
            this.meta = bus.$data[this.metaName];
            this.meta.META_FIELD.forEach((e) => {
                if (e.FORM_TYPE.match('subform-') === null && e.FORM_TYPE!='') {
                    me.meta_field[e.DB_NAME] = e;
                }
            });
        }
    });
</script>